---
phase: 05-spells-conditions-resume
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/io/logger.py
  - src/simulation/simulator.py
  - run.py
  - src/cli/batch_args.py
autonomous: true

must_haves:
  truths:
    - "Single-run verbose mode displays LLM thinking blocks inline with combat log"
    - "Dice rolls show detailed notation (e.g., 2d20kh1 for advantage) in verbose mode"
    - "Non-verbose mode is unchanged (existing behavior preserved)"
    - "--verbose flag in single-run mode enables detailed output"
  artifacts:
    - path: "src/io/logger.py"
      provides: "Enhanced logger with verbose dice detail and LLM thinking display"
      contains: "log_dice_detail"
    - path: "run.py"
      provides: "Verbose single-run mode entry point"
      contains: "verbose"
  key_links:
    - from: "src/simulation/simulator.py"
      to: "src/io/logger.py"
      via: "passes dice detail strings to logger in verbose mode"
      pattern: "log_dice_detail"
    - from: "run.py"
      to: "src/simulation/simulator.py"
      via: "passes verbose flag through to combat runner"
      pattern: "verbose"
---

<objective>
Add a verbose single-run mode that displays LLM thinking blocks and detailed dice rolls live during combat. When a DM runs a single combat with `--verbose`, they see every roll's dice notation and the LLM agent's reasoning.

Purpose: Satisfies LOG-03. Gives DMs transparency into how decisions are made and how randomness plays out, making the simulator useful for understanding combat dynamics, not just outcomes.

Output: Enhanced CombatLogger with verbose dice detail, simulator passing dice strings to logger, CLI verbose flag for single-run mode.
</objective>

<execution_context>
@/Users/enrico/.claude/get-shit-done/workflows/execute-plan.md
@/Users/enrico/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-spells-conditions-resume/05-RESEARCH.md
@src/io/logger.py
@src/simulation/simulator.py
@src/agents/heuristic.py
@run.py
@src/cli/batch_args.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhanced logger with dice detail and LLM thinking display</name>
  <files>
    src/io/logger.py
  </files>
  <action>
Add two new methods to `CombatLogger` in `src/io/logger.py`:

**1. `log_dice_detail(self, context: str, dice_expr: str, roll_str: str, total: int)`:**

Logs detailed dice information when verbose is enabled. Format:
```
      [dice] context: dice_expr -> roll_str = total
```

For example:
```
      [dice] Attack roll: 2d20kh1 -> 2d20kh1 (18, 7) = 18
      [dice] Damage: 2d6+3 -> 2d6 (4, 2) + 3 = 9
      [dice] Concentration save: 1d20 -> 1d20 (14) = 14
```

Only log when `self.verbose` is True. This prevents noise in batch mode.

```python
def log_dice_detail(self, context: str, dice_expr: str, roll_str: str, total: int):
    """Log detailed dice roll information in verbose mode."""
    if not self.verbose:
        return
    msg = f"      [dice] {context}: {dice_expr} -> {roll_str} = {total}"
    self.entries.append(msg)
    print(msg)
```

**2. `log_llm_thinking(self, creature_name: str, thinking: str)`:**

Displays the LLM agent's `<thinking>` block content when present.

```python
def log_llm_thinking(self, creature_name: str, thinking: str):
    """Log LLM agent's thinking/reasoning in verbose mode."""
    if not self.verbose or not thinking:
        return
    self.log(f"  [{creature_name} thinking]")
    for line in thinking.strip().splitlines():
        msg = f"    | {line.strip()}"
        self.entries.append(msg)
        print(msg)
```

**3. Enhance `log_attack` to optionally show advantage state:**

Add optional `advantage_desc: str | None = None` parameter to `log_attack`:

```python
def log_attack(self, attacker_name, target_name, attack_name, attack_result, advantage_desc=None):
```

If `advantage_desc` is provided and verbose is True, append it to the attack log line:
```python
if self.verbose and advantage_desc:
    msg += f" [{advantage_desc}]"
```

This shows lines like:
```
  Fighter attacks Goblin with Longsword: Hit! (rolled 15+5=20 vs AC 13) [advantage: target_prone_melee]
```
  </action>
  <verify>cd /Users/enrico/workspace/myobsidian/dnd-simulator && python -c "from src.io.logger import CombatLogger; l = CombatLogger(verbose=True); l.log_dice_detail('Attack', '1d20', '1d20 (15)', 15); l.log_llm_thinking('Wizard', 'Target the weakest enemy'); print('OK')"</verify>
  <done>CombatLogger has log_dice_detail, log_llm_thinking, and advantage_desc in log_attack; all only active in verbose mode</done>
</task>

<task type="auto">
  <name>Task 2: Wire verbose dice details through simulator and CLI</name>
  <files>
    src/simulation/simulator.py
    run.py
    src/cli/batch_args.py
  </files>
  <action>
**1. Simulator changes (`src/simulation/simulator.py`):**

The `run_combat()` function already receives a `verbose` parameter and creates `CombatLogger(verbose=verbose)`. The logger is already verbose-aware.

After each `rules.make_attack_roll()` call in the main attack loop, if the logger is verbose, log dice detail. The `roll_d20()` function in dice.py returns `(total, str_repr)`. The `make_attack_roll()` in rules.py uses `roll_d20()` internally but doesn't expose the string.

Rather than changing the rules API, add dice detail logging AFTER the attack result is constructed. Use the `attack_result.natural_roll`, `attack_result.bonus`, `attack_result.total` that are already on AttackResult:

```python
if logger.verbose:
    logger.log_dice_detail(
        "Attack roll",
        f"d20+{atk.attack_bonus}",
        f"d20({res.natural_roll})+{atk.attack_bonus}",
        res.total
    )
```

After `rules.roll_damage_for_attack()`, log the damage dice detail. The `roll_damage()` function returns `(total, str_repr)`. Since `roll_damage_for_attack()` only returns the total, either:
(a) Change `roll_damage_for_attack()` to also return the string, OR
(b) Log the dice expression and total without the detailed breakdown.

Option (b) is simpler and avoids API changes:
```python
if logger.verbose:
    logger.log_dice_detail(
        "Damage",
        atk.damage.dice + (" (crit)" if res.is_critical else ""),
        f"{dmg}",
        dmg
    )
```

For the advantage description in attack logging, pass the resolved advantage state:
```python
adv_desc = None
if adv_sources or disadv_sources:
    if advantage_state == AdvantageState.ADVANTAGE:
        adv_desc = f"advantage: {', '.join(adv_sources)}"
    elif advantage_state == AdvantageState.DISADVANTAGE:
        adv_desc = f"disadvantage: {', '.join(disadv_sources)}"
    else:
        adv_desc = f"normal (adv: {', '.join(adv_sources)} vs disadv: {', '.join(disadv_sources)})"

logger.log_attack(c.name, target.name, atk.name, res, advantage_desc=adv_desc)
```

For the LLM thinking: in `run_combat()`, the agent's `choose_action()` returns an `AgentAction`. Check for a `thinking` attribute:
```python
if logger.verbose and hasattr(action, 'thinking') and action.thinking:
    logger.log_llm_thinking(c.name, action.thinking)
```

This is passive — it only triggers when an LLM agent populates the `thinking` field (which the LLM agent from Phase 3 already does via `strategy_summary`; for actual thinking content the LLM parser stores it). For heuristic agents, no thinking is logged.

**2. CLI changes:**

In `run.py`, `run_single_combat()` already passes `verbose=True` to `run_combat()`. The `--verbose` flag in batch_args.py is currently described as "ignored in single combat mode". Update the single combat path to respect `--verbose`:

In `run_single_combat()`, change:
```python
final_state, logger = run_combat(creatures, agent, seed=seed, verbose=True, terrain=terrain)
```
to always use verbose=True for single combat (which is already the case). The new logger methods only fire when verbose=True, so this is already correct.

No changes needed to batch_args.py — the `--verbose` flag already exists. Just ensure single-run mode uses verbose=True (it does).
  </action>
  <verify>cd /Users/enrico/workspace/myobsidian/dnd-simulator && python run.py --party fighter.md --enemies goblin --seed 42 2>&1 | head -40</verify>
  <done>Single-run mode shows dice detail and advantage descriptions; LLM thinking blocks display when LLM agent is used; batch mode unaffected</done>
</task>

</tasks>

<verification>
```bash
cd /Users/enrico/workspace/myobsidian/dnd-simulator

# Single run with verbose output (shows dice details)
python run.py --party fighter.md --enemies goblin --seed 42

# Batch mode unaffected (no dice detail noise)
python run.py --party fighter.md --enemies goblin --runs 10 --seed 42

# Full test suite
python -m pytest tests/ -v
```
</verification>

<success_criteria>
- Single-run verbose mode shows dice detail lines (attack roll, damage)
- Advantage/disadvantage sources shown in attack log lines when present
- LLM thinking blocks displayed when LLM agent provides them
- Batch mode (verbose=False) shows no extra detail (no regression)
- All existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-spells-conditions-resume/05-04-SUMMARY.md`
</output>
