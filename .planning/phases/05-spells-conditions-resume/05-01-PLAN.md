---
phase: 05-spells-conditions-resume
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/domain/creature.py
  - src/domain/conditions.py
  - src/domain/rules.py
  - src/io/markdown.py
  - data/creatures/wizard.md
  - tests/test_conditions.py
  - tests/test_creature.py
  - tests/test_rules.py
autonomous: true

must_haves:
  truths:
    - "Creature model accepts conditions, spell_slots, and concentration fields with backward-compatible defaults"
    - "Action model accepts spell_level and is_concentration fields with backward-compatible defaults"
    - "conditions.py returns correct advantage/disadvantage sources for prone, frightened, stunned, grappled"
    - "Prone target gives melee attackers advantage and ranged attackers disadvantage"
    - "Concentration save uses DC = max(10, damage // 2) with CON modifier"
    - "Wizard markdown loads with spell_slots and spell_level metadata"
  artifacts:
    - path: "src/domain/conditions.py"
      provides: "Condition-to-advantage mapping functions"
      contains: "get_attacker_disadvantage_sources"
    - path: "src/domain/creature.py"
      provides: "Extended Creature and Action models"
      contains: "spell_slots"
    - path: "src/domain/rules.py"
      provides: "Concentration save function"
      contains: "make_concentration_save"
    - path: "data/creatures/wizard.md"
      provides: "Wizard with spell slots and spell metadata"
      contains: "spell_slots"
  key_links:
    - from: "src/domain/conditions.py"
      to: "src/domain/dice.py"
      via: "returns source lists compatible with resolve_advantage()"
      pattern: "list\\[str\\]"
    - from: "src/domain/rules.py"
      to: "src/domain/dice.py"
      via: "make_concentration_save calls make_saving_throw"
      pattern: "make_saving_throw"
    - from: "src/io/markdown.py"
      to: "src/domain/creature.py"
      via: "parses spell_level, is_concentration from action YAML"
      pattern: "spell_level"
---

<objective>
Add spell slot tracking, concentration, and condition fields to domain models; implement condition-to-advantage mapping module; add concentration save to rules engine; update markdown parser and wizard data file.

Purpose: Establish the domain foundation that the simulator (Plan 05-02) will integrate. All new fields use safe defaults so existing creatures and tests keep working without changes.

Output: Extended Creature/Action models, `src/domain/conditions.py`, concentration save in rules.py, updated wizard.md with spell metadata, comprehensive tests.
</objective>

<execution_context>
@/Users/enrico/.claude/get-shit-done/workflows/execute-plan.md
@/Users/enrico/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-spells-conditions-resume/05-RESEARCH.md
@src/domain/creature.py
@src/domain/dice.py
@src/domain/rules.py
@src/io/markdown.py
@data/creatures/wizard.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Creature and Action models with spell/condition fields</name>
  <files>
    src/domain/creature.py
    tests/test_creature.py
  </files>
  <action>
RED: Write tests in `tests/test_creature.py`:
- Test Creature with `conditions: list[str] = []` — empty by default, accepts ["prone", "frightened"]
- Test Creature with `spell_slots: dict[int, int] = {}` — empty by default, accepts {1: 4, 2: 3, 3: 2}
- Test Creature with `concentration: Optional[str] = None` — None by default, accepts "Haste"
- Test Action with `spell_level: Optional[int] = None` — None by default, accepts 3
- Test Action with `is_concentration: bool = False` — False by default, accepts True
- Test backward compatibility: existing Creature() with no new fields still works
- Test `model_copy(update={"conditions": ["prone"]})` creates new instance correctly

GREEN: Add to `Creature` class in `src/domain/creature.py`:
```python
conditions: list[str] = []
spell_slots: dict[int, int] = {}
concentration: Optional[str] = None
```

Add to `Action` class:
```python
spell_level: Optional[int] = None
is_concentration: bool = False
```

These go AFTER the existing fields. All have defaults so existing code is unaffected.
  </action>
  <verify>cd /Users/enrico/workspace/myobsidian/dnd-simulator && python -m pytest tests/test_creature.py -v</verify>
  <done>Creature accepts conditions, spell_slots, concentration; Action accepts spell_level, is_concentration; all existing tests still pass</done>
</task>

<task type="auto">
  <name>Task 2: Create conditions module and concentration save</name>
  <files>
    src/domain/conditions.py
    src/domain/rules.py
    tests/test_conditions.py
    tests/test_rules.py
  </files>
  <action>
RED: Write tests:

In `tests/test_conditions.py`:
- `test_prone_attacker_has_disadvantage`: attacker with ["prone"] -> get_attacker_disadvantage_sources returns ["prone"]
- `test_frightened_attacker_has_disadvantage`: attacker with ["frightened"] -> returns ["frightened"]
- `test_no_conditions_no_sources`: attacker with [] -> returns []
- `test_prone_target_melee_gives_advantage`: target ["prone"], is_melee=True -> get_target_advantage_sources returns source containing "prone"
- `test_prone_target_ranged_gives_disadvantage`: target ["prone"], is_melee=False -> get_target_disadvantage_sources returns source containing "prone"
- `test_stunned_target_gives_advantage`: target ["stunned"] -> get_target_advantage_sources returns source
- `test_grappled_has_no_attack_advantage_effects`: grappled target -> no advantage or disadvantage on attacks against it
- `test_stunned_auto_fails_str_dex_saves`: target ["stunned"] -> get_save_auto_fail returns True for "str" and "dex"

In `tests/test_rules.py`:
- `test_concentration_save_dc_minimum_10`: damage=5 -> DC should be 10 (not 2)
- `test_concentration_save_dc_half_damage`: damage=30 -> DC should be 15
- `test_concentration_save_success`: mock roll high enough to pass
- `test_concentration_save_failure`: mock roll too low to pass

GREEN: Create `src/domain/conditions.py`:

```python
"""Condition effects on combat mechanics (advantage/disadvantage sources)."""

# Conditions that give the ATTACKER disadvantage on their own attack rolls
CONDITION_ATTACK_DISADVANTAGE = {"prone", "frightened", "poisoned", "blinded"}

# Conditions on a TARGET that give attackers advantage
CONDITION_TARGET_ADVANTAGE_MELEE = {"prone", "stunned", "paralyzed", "restrained"}

# Conditions that cause auto-fail on STR/DEX saves
CONDITION_SAVE_AUTO_FAIL_STR_DEX = {"stunned", "paralyzed"}


def get_attacker_disadvantage_sources(attacker) -> list[str]:
    """Return conditions on attacker that impose disadvantage on attack rolls."""
    return [c for c in attacker.conditions if c in CONDITION_ATTACK_DISADVANTAGE]


def get_target_advantage_sources(attacker, target, is_melee: bool) -> list[str]:
    """Return sources of advantage when attacking this target."""
    sources = []
    if "stunned" in target.conditions or "paralyzed" in target.conditions:
        sources.append("target_incapacitated")
    if "prone" in target.conditions and is_melee:
        sources.append("target_prone_melee")
    if "restrained" in target.conditions:
        sources.append("target_restrained")
    return sources


def get_target_disadvantage_sources(attacker, target, is_melee: bool) -> list[str]:
    """Return sources of disadvantage when attacking this target."""
    sources = []
    if "prone" in target.conditions and not is_melee:
        sources.append("target_prone_ranged")
    return sources


def is_save_auto_fail(creature, save_ability: str) -> bool:
    """Check if creature auto-fails a save due to conditions (stunned/paralyzed -> STR/DEX)."""
    if save_ability.lower() in ("str", "dex"):
        return any(c in CONDITION_SAVE_AUTO_FAIL_STR_DEX for c in creature.conditions)
    return False
```

Add to `src/domain/rules.py`:

```python
def make_concentration_save(creature, damage_taken: int) -> SavingThrowResult:
    """CON save to maintain concentration. DC = max(10, damage // 2)."""
    dc = max(10, damage_taken // 2)
    con_mod = creature.ability_scores.get_modifier("con")
    return make_saving_throw(con_mod, dc)
```

Place this function after the existing `make_saving_throw` function. Import nothing new — it calls the existing `make_saving_throw`.
  </action>
  <verify>cd /Users/enrico/workspace/myobsidian/dnd-simulator && python -m pytest tests/test_conditions.py tests/test_rules.py -v</verify>
  <done>conditions.py maps all 4 required conditions (prone, frightened, stunned, grappled) to correct advantage/disadvantage; concentration save uses DC = max(10, damage // 2)</done>
</task>

<task type="auto">
  <name>Task 3: Update markdown parser and wizard data with spell metadata</name>
  <files>
    src/io/markdown.py
    data/creatures/wizard.md
    tests/test_markdown.py
  </files>
  <action>
RED: Add tests in `tests/test_markdown.py`:
- `test_load_creature_with_spell_slots`: load wizard.md, verify creature.spell_slots == {1: 4, 2: 3, 3: 2}
- `test_load_creature_with_spell_level`: load wizard.md, verify Fireball action has spell_level == 3
- `test_load_creature_with_is_concentration`: verify Fire Bolt has is_concentration == False, and any concentration spell has is_concentration == True
- `test_load_creature_without_spell_fields`: load a non-spellcaster (e.g. fighter.md), verify spell_slots == {} and concentration is None

GREEN:

1. Update `data/creatures/wizard.md` frontmatter — add spell_slots and spell metadata:
```yaml
spell_slots:
  1: 4
  2: 3
  3: 2
```

Add to Fireball action: `spell_level: 3` and `is_concentration: false`
Add to Fire Bolt action: (no spell_level needed — cantrip)

Also add a concentration spell example for testing:
```yaml
  - name: Haste
    description: "Concentration. One creature gains +2 AC, doubled speed, extra action."
    spell_level: 3
    is_concentration: true
    attacks: []
```

2. Update `src/io/markdown.py` `load_creature()`:
- After parsing damage_vulnerabilities, add: `spell_slots=data.get("spell_slots", {})`
- In action parsing loop, add: `spell_level=action_data.get("spell_level")` and `is_concentration=action_data.get("is_concentration", False)` to the Action constructor
- Pass `spell_slots` to the Creature constructor

No changes needed for `conditions` or `concentration` in the loader — those are runtime state, not defined in markdown files.
  </action>
  <verify>cd /Users/enrico/workspace/myobsidian/dnd-simulator && python -m pytest tests/test_markdown.py -v</verify>
  <done>Wizard loads with spell_slots={1:4, 2:3, 3:2}; Fireball has spell_level=3; Haste has is_concentration=True; non-spellcasters unaffected</done>
</task>

</tasks>

<verification>
```bash
cd /Users/enrico/workspace/myobsidian/dnd-simulator
python -m pytest tests/test_creature.py tests/test_conditions.py tests/test_rules.py tests/test_markdown.py -v
python -m pytest tests/ -v  # Full test suite still green
```
</verification>

<success_criteria>
- Creature model accepts conditions, spell_slots, concentration with safe defaults
- Action model accepts spell_level, is_concentration with safe defaults
- conditions.py correctly maps prone/frightened/stunned/grappled to advantage/disadvantage
- Concentration save DC = max(10, damage // 2)
- Wizard markdown loads with spell metadata
- All existing tests still pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/05-spells-conditions-resume/05-01-SUMMARY.md`
</output>
