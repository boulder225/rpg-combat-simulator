---
phase: 04-terminal-ui-advanced-combat
plan: 06
type: execute
wave: 2
depends_on: [04-05]
files_modified:
  - src/tui/app.py
  - src/tui/widgets/log_viewer.py
  - src/tui/widgets/results_panel.py
  - src/tui/screens/
autonomous: true

must_haves:
  truths:
    - "DM can scroll through combat log in TUI (last run only for Phase 4)"
    - "Result tables show win %, CI, difficulty, damage breakdown with colored formatting"
    - "TUI has panels or tabs for progress, log, and results; keyboard navigation"
  artifacts:
    - path: "src/tui/widgets/log_viewer.py"
      provides: "Scrollable combat log widget (last run)"
    - path: "src/tui/widgets/results_panel.py"
      provides: "Results: win rate, CI, difficulty, top damage sources; Rich/Textual styling"
    - path: "src/tui/app.py"
      provides: "Compose log + results; populate from BatchResults and last logger"
  key_links:
    - from: "src/tui/app.py"
      to: "src/simulation/batch_runner.py"
      via: "BatchResults and last run logger after completion"
      pattern: "BatchResults|get_full_log"
---

<objective>
Add combat log viewer and results panel to the TUI so the DM can scroll the log (last run) and see colored result tables (win %, confidence interval, difficulty, damage breakdown).

Purpose: Success criteria 2 and 3 require "DM can scroll through combat log in TUI and see round-by-round positions and actions" and "Result tables show win percentages, duration, damage breakdown with colored formatting". Phase 4 scope: last run only for log; full BatchResults for results panel.

Output: Scrollable log widget (content from last run's CombatLogger.get_full_log()); results panel with win rate, 95% CI, difficulty label, avg duration, top damage sources (from BatchResults); layout (vertical or tabs) so user can switch between progress/log/results; keyboard navigation (e.g. Tab or panels).
</objective>

<execution_context>
@.planning/phases/04-terminal-ui-advanced-combat/04-CONTEXT.md
</execution_context>

<context>
@.planning/phases/04-terminal-ui-advanced-combat/04-CONTEXT.md
@src/simulation/batch_runner.py
@src/output/report_generator.py
@src/tui/app.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scrollable combat log widget</name>
  <files>src/tui/widgets/log_viewer.py</files>
  <action>
- Widget that displays text (combat log) and is scrollable (Textual ScrollableContainer + Rich Log or similar). Set content from last run's logger.get_full_log() when batch completes.
- Expose method to set_content(log_text: str). TUI app stores last run's logger and passes get_full_log() to this widget after batch finishes.
  </action>
  <verify>Log viewer shows multi-line log and can scroll</verify>
  <done>Log viewer widget exists and displays last run log</done>
</task>

<task type="auto">
  <name>Task 2: Results panel widget</name>
  <files>src/tui/widgets/results_panel.py</files>
  <action>
- Widget that displays: Party Win Rate: X%; 95% CI: [L, U]; Difficulty: Easy/Medium/Hard/Deadly; Avg duration (wins/losses); Top damage dealers (from BatchResults.damage_breakdown). Use Rich markup or Textual styling for colors (e.g. green for Easy, red for Deadly).
- Accept BatchResults (and optionally difficulty label from calculate_difficulty_rating). Populate when batch completes.
  </action>
  <verify>Results panel shows win rate, CI, difficulty, damage breakdown with color</verify>
  <done>Results panel displays BatchResults with formatting</done>
</task>

<task type="auto">
  <name>Task 3: TUI layout and navigation</name>
  <files>src/tui/app.py</files>
  <action>
- Compose layout: e.g. top = progress bar + run count (during run) or "Complete" (after); middle = HorizontalTabs or Vertical split: "Log" | "Results". Log tab = log viewer; Results tab = results panel. Or single screen with scroll: progress, then log, then results.
- After batch completes: pass last_run_log to log viewer, BatchResults to results panel. Ensure keyboard navigation (Tab, arrows) works per Textual docs.
  </action>
  <verify>--tui run: after batch, user can scroll log and see results panel with correct data</verify>
  <done>TUI shows log and results with navigation</done>
</task>
</tasks>
