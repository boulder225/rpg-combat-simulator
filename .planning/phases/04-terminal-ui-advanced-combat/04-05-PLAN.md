---
phase: 04-terminal-ui-advanced-combat
plan: 05
type: execute
wave: 2
depends_on: []
files_modified:
  - pyproject.toml
  - run.py
  - src/cli/batch_args.py
  - src/tui/app.py
  - src/tui/widgets/progress.py
  - src/tui/__init__.py
autonomous: true

must_haves:
  truths:
    - "run.py --tui launches Textual app instead of printing to terminal; without --tui, current CLI behavior unchanged"
    - "Batch simulation runs inside a Textual worker; main thread stays responsive"
    - "Progress bar and run count (X of N) and live win % update during batch run"
    - "Use post_message or call_from_thread for worker -> UI updates (no blocking in event loop)"
  artifacts:
    - path: "pyproject.toml"
      provides: "textual dependency added"
    - path: "src/tui/app.py"
      provides: "Textual App, screen that starts batch run in worker"
    - path: "src/tui/widgets/progress.py"
      provides: "Progress bar widget, run count, win % display"
    - path: "run.py"
      provides: "If args.tui: launch TUI app; else existing single/batch flow"
  key_links:
    - from: "src/tui/app.py"
      to: "src/simulation/batch_runner.py"
      via: "Run batch in worker; consume progress callback or results"
      pattern: "BatchRunner|run_worker"
    - from: "src/tui/app.py"
      to: "textual"
      via: "App, run_worker, post_message"
      pattern: "from textual"
---

<objective>
Add TUI entry point and progress display: --tui launches a Textual app that runs batch simulation in a background worker and shows live progress (X of N runs, win % so far).

Purpose: Success criterion 1 requires "TUI displays live progress bars during batch simulation showing X of N runs complete". CLI remains default; TUI is opt-in. No combat log viewer or results panel in this plan.

Output: textual in pyproject.toml; run.py branches on --tui to launch TUI; Textual App with one screen that (1) starts batch run in run_worker, (2) shows progress bar and run count / win %, (3) updates via messages from worker (call_from_thread or post_message). BatchRunner or MonteCarloSimulator must support a progress callback that the TUI can subscribe to.
</objective>

<execution_context>
@.planning/phases/04-terminal-ui-advanced-combat/04-CONTEXT.md
</execution_context>

<context>
@.planning/phases/04-terminal-ui-advanced-combat/04-CONTEXT.md
@.planning/research/ARCHITECTURE.md
@src/simulation/batch_runner.py
@src/simulation/monte_carlo.py
@run.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Textual dependency</name>
  <files>pyproject.toml</files>
  <action>
- Add textual to project dependencies (e.g. "textual>=0.40" or version from research). Ensure compatible with Python 3.11.
  </action>
  <verify>uv sync && python -c "import textual; print(textual.__version__)"</verify>
  <done>Textual installable and importable</done>
</task>

<task type="auto">
  <name>Task 2: CLI --tui and TUI entry</name>
  <files>src/cli/batch_args.py, run.py</files>
  <action>
- Add --tui flag to batch args (default False). In main(): if args.tui, import and run TUI app (e.g. from src.tui.app import run_tui; run_tui(args) or App().run()) instead of run_single_combat / run_batch_simulation. Pass same creature/agent/runs/seed as would be used for batch.
  </action>
  <verify>python run.py --party fighter.md --enemies goblin --runs 5 --tui launches Textual app</verify>
  <done>--tui launches TUI; other args passed through</done>
</task>

<task type="auto">
  <name>Task 3: Progress callback from batch runner</name>
  <files>src/simulation/batch_runner.py</files>
  <action>
- BatchRunner (or MonteCarloSimulator) already may yield or callback progress. If not, add optional on_progress(run_index, total_runs, wins_so_far, ...) callback or ensure existing progress mechanism can be passed to TUI. TUI will pass a callback that posts a message to the app.
  </action>
  <verify>Batch run can report progress to a callback without blocking</verify>
  <done>Progress callback available for TUI</done>
</task>

<task type="auto">
  <name>Task 4: Textual App and progress screen</name>
  <files>src/tui/app.py, src/tui/widgets/progress.py, src/tui/__init__.py</files>
  <action>
- Create src/tui/ package. app.py: Textual App subclass; compose or mount a screen that shows a progress bar (ProgressBar), Static for "Run X of N", Static for "Party wins: Y%". Start batch in run_worker; from worker, use call_from_thread to post progress updates (e.g. ProgressUpdate(run_index, total, wins)). Handler updates progress bar and statics. On completion, show simple "Complete" or store results for next plan.
- Widgets: progress bar widget and labels. Use reactive state or message handler to update.
  </action>
  <verify>Run with --tui --runs 10: app shows progress bar filling and run count updating; no freeze</verify>
  <done>TUI shows live progress during batch</done>
</task>
</tasks>
