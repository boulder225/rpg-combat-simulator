---
phase: 04-terminal-ui-advanced-combat
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/domain/creature.py
  - src/domain/rules.py
  - src/simulation/simulator.py
  - src/agents/base.py
  - src/agents/heuristic.py
  - src/agents/llm_validator.py
  - src/agents/llm_prompt.py
autonomous: true

must_haves:
  truths:
    - "At least one AoE action (Fireball): sphere, radius 4 squares, DEX save, 8d6 fire damage"
    - "Creatures in sphere (Manhattan distance from center <= 4) make save and take damage on failure (half on success)"
    - "Caster chooses center cell; simulator resolves all targets in area"
    - "Heuristic and LLM agents can choose Fireball + center when creature has the action"
  artifacts:
    - path: "src/domain/creature.py"
      provides: "Action may have area_shape, radius_squares, save_ability, save_dc (optional) for AoE"
    - path: "src/simulation/simulator.py"
      provides: "Resolve AoE action: collect creatures in sphere, roll save each, apply damage"
    - path: "src/agents/base.py"
      provides: "AgentAction may include target_position (for AoE center) when action is AoE"
    - path: "src/agents/heuristic.py"
      provides: "If creature has AoE action and multiple enemies in area, consider using it (optional simple logic)"
  key_links:
    - from: "src/simulation/simulator.py"
      to: "src/domain/distance.py"
      via: "manhattan_distance from center to each creature"
      pattern: "manhattan_distance"
---

<objective>
Add Fireball-style sphere AoE: one action type with area shape sphere, radius 4 squares, DEX save, 8d6 fire damage. Simulator resolves all creatures in area; agents can select the action and center cell.

Purpose: Success criterion 6 requires "Fireball (sphere AoE) hits all creatures within grid radius". Phase 4 scope is sphere only (cone/line deferred).

Output: Creature Action model extended for optional AoE fields; simulator branch for AoE resolution (collect targets in sphere, save, damage); AgentAction supports target_position for AoE center; at least one creature/action definition (e.g. wizard or custom) has Fireball; heuristic can use it when beneficial; LLM prompt mentions AoE and center choice.
</objective>

<execution_context>
@.planning/phases/04-terminal-ui-advanced-combat/04-CONTEXT.md
</execution_context>

<context>
@.planning/phases/04-terminal-ui-advanced-combat/04-CONTEXT.md
@src/domain/creature.py
@src/domain/rules.py
@src/simulation/simulator.py
@src/agents/base.py
@src/domain/distance.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Action model supports AoE</name>
  <files>src/domain/creature.py</files>
  <action>
- Add optional fields to Action: area_shape: Literal["sphere"] | None, radius_squares: int | None, save_ability: str | None (e.g. "DEX"), save_dc: int | None, damage: DamageRoll | None (for AoE damage). If area_shape is set, this action is resolved as AoE (no attacks list needed, or attacks ignored for AoE).
- Backward compatible: existing actions have these None.
  </action>
  <verify>Action(area_shape="sphere", radius_squares=4, save_ability="DEX", save_dc=14, damage=DamageRoll(dice="8d6", damage_type="fire")) validates</verify>
  <done>Action can represent Fireball-style AoE</done>
</task>

<task type="auto">
  <name>Task 2: Simulator resolves AoE action</name>
  <files>src/simulation/simulator.py</files>
  <action>
- When agent chooses action with area_shape (e.g. sphere): need center position (target_position or move_to or current position). Collect all living creatures where manhattan_distance(center, creature.position) <= radius_squares. For each: roll save (rules or dice), apply damage (full or half on success). Apply damage modifiers (resistance/immunity/vulnerability). Update state, log.
- Integrate in turn loop: after resolving action type, if action is AoE, branch to AoE resolution instead of attack resolution.
  </action>
  <verify>Test or manual: creature with Fireball at center C3; enemies at C2, D4, E5; C2 and D4 in radius, E5 out; only C2 and D4 take damage</verify>
  <done>AoE resolution in simulator; sphere and save/damage correct</done>
</task>

<task type="auto">
  <name>Task 3: AgentAction and agents support AoE</name>
  <files>src/agents/base.py, src/agents/heuristic.py, src/agents/llm_parser.py, src/agents/llm_validator.py, src/agents/llm_prompt.py</files>
  <action>
- AgentAction: add target_position: Optional[str] = None for AoE center. When action is AoE, validator accepts target_position; simulator uses it as center.
- Heuristic: if creature has AoE action and 2+ enemies, optionally choose center that maximizes enemies in radius (simple: centroid of enemies or first enemy position). Else skip AoE for now.
- LLM: prompt mentions AoE actions and "if you use one, set TARGET to center cell (e.g. D4)". Parser/validator: for AoE action, target can be position; resolve target_position from movement or target field.
  </action>
  <verify>End-to-end: creature with Fireball can be given action + center; simulator resolves AoE</verify>
  <done>Agents can select AoE and center; validator and simulator wired</done>
</task>

<task type="auto">
  <name>Task 4: Fireball creature or fixture</name>
  <files>data/creatures/wizard.md or tests/fixtures</files>
  <action>
- Add at least one creature definition with Fireball action (sphere, 4 squares, DEX save, 8d6 fire) for manual/CI testing. Can be data/creatures/wizard.md or fixture in tests.
  </action>
  <verify>Load wizard (or fixture); run combat with AoE; confirm damage applied to multiple targets</verify>
  <done>Fireball available in data or fixtures</done>
</task>
</tasks>
