---
phase: 01-foundation-core-combat
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/domain/rules.py
  - src/io/logger.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Combat resolves using real D&D 5e attack and damage mechanics"
    - "Combat log records dice rolls, hit/miss, damage"
  artifacts:
    - path: "src/domain/rules.py"
      provides: "Attack vs AC, damage, crits, HP rules"
    - path: "src/io/logger.py"
      provides: "Structured combat log entries"
  key_links:
    - from: "rules.py"
      to: "logger.py"
      via: "log_attack/log_damage"
      pattern: "log_.*attack|log_.*damage"
---

<objective>
Implement real 5e combat mechanics and detailed logging.

Purpose: Close core rules and logging gaps blocking Phase 1 verification.
Output: Functional rules engine and per-action combat logs.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
</context>

<tasks>

<task type="auto">
  <name>Implement attack, damage, HP rules</name>
  <files>src/domain/rules.py</files>
  <action>
    Replace stubs with D&D 5e mechanics: d20 attack vs AC with modifiers, crit on natural 20, damage dice by type, apply resistance/immunity, track HP to 0 and death condition.
  </action>
  <verify>pytest -q || true</verify>
  <done>Attacks produce hit/miss, variable damage, and reduce HP correctly</done>
</task>

<task type="auto">
  <name>Add structured combat logging</name>
  <files>src/io/logger.py</files>
  <action>
    Add log entries for initiative rolls, attack rolls, hit/miss results, damage amounts, and HP changes. Avoid print-only end logs.
  </action>
  <verify>python run.py --dry-run || true</verify>
  <done>Each action emits readable log entries with dice details</done>
</task>

</tasks>

<verification>
Rules functions return variable outcomes; logger shows roll-by-roll output.
</verification>

<success_criteria>
Core mechanics and logging no longer stubbed.
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-core-combat/01-04-SUMMARY.md`
</output>
