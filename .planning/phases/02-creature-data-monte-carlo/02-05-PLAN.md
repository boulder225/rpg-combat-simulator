---
phase: 02-creature-data-monte-carlo
plan: 05
type: execute
wave: 3
depends_on: ["02-03", "02-04"]
files_modified:
  - run.py
  - src/cli/batch_args.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "CLI accepts creature names without .md extension for SRD lookup"
    - "CLI supports --runs parameter for batch simulation"
    - "DM can run 'python run.py --party fighter.md --enemies goblin goblin goblin --runs 500'"
  artifacts:
    - path: "run.py"
      provides: "Updated CLI entry point with batch simulation support"
      contains: "argparse with --runs, --party, --enemies"
    - path: "src/cli/batch_args.py"
      provides: "CLI argument parsing for batch simulation"
      exports: ["parse_batch_args"]
  key_links:
    - from: "run.py"
      to: "src/io/creature_loader.py"
      via: "creature loading"
      pattern: "CreatureLoader\\(\\)\\.load_creature"
    - from: "run.py"
      to: "src/simulation/batch_runner.py"
      via: "batch execution"
      pattern: "BatchRunner\\(\\)\\.run_batch"

---

<objective>
Integrate batch simulation capabilities into CLI with SRD creature support and proper argument parsing.

Purpose: Enable the core DM workflow where they can specify SRD creature names directly and run batch simulations with configurable run counts.
Output: Updated CLI that supports batch simulation with SRD creatures and proper argument handling.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-creature-data-monte-carlo/02-CONTEXT.md
@.planning/phases/02-creature-data-monte-carlo/02-RESEARCH.md

@run.py
@src/io/creature_loader.py
@src/simulation/batch_runner.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CLI argument parser for batch simulation</name>
  <files>src/cli/batch_args.py</files>
  <action>
Create CLI argument parsing utilities for batch simulation:
- Implement parse_batch_args() function that uses argparse to handle:
  - --party: list of party creature files/names (supports .md and SRD names)
  - --enemies: list of enemy creature files/names (supports .md and SRD names)  
  - --runs: number of simulation runs (default 100 if not specified)
  - --seed: random seed for reproducibility
  - --verbose: verbose output flag
- Handle creature name resolution: names without .md extension are treated as SRD lookups
- Include proper help text and validation
- Return parsed arguments as a dataclass or namespace
- Support the exact workflow: python run.py --party fighter.md --enemies goblin goblin goblin --runs 500
  </action>
  <verify>python -c "from src.cli.batch_args import parse_batch_args; print('Batch args parser imported successfully')"</verify>
  <done>Argument parser correctly handles party/enemies lists and resolves SRD vs local files</done>
</task>

<task type="auto">
  <name>Task 2: Update main CLI entry point</name>
  <files>run.py</files>
  <action>
Update run.py to support batch simulation with SRD creatures:
- Import and use parse_batch_args from src.cli.batch_args
- Initialize CreatureLoader with data/creatures and data/srd-cache directories
- Initialize BatchRunner with proper components
- Implement main() function that:
  - Parses arguments
  - Loads creatures using creature_loader
  - Runs batch simulation
  - Displays live progress during execution: "[=====>    ] 300 runs | Party: 72% (67%-77%)"
  - Shows final results with confidence intervals and difficulty rating
- Handle both single simulation (Phase 1) and batch simulation (Phase 2) modes
- Maintain backward compatibility with existing single-run functionality
- Include proper error handling and user feedback
  </action>
  <verify>python run.py --help</verify>
  <done>CLI supports both single simulation and batch simulation with SRD creature names</done>
</task>

</tasks>

<verification>
- DM can run "python run.py --party fighter.md --enemies goblin goblin goblin --runs 500" successfully
- Creature names without .md extension (like "goblin") are resolved as SRD lookups
- Local .md files take precedence over SRD data
- Live progress shows current run count and win percentage with confidence interval
</verification>

<success_criteria>
- CLI accepts the exact command format specified in context
- SRD creatures are fetched and cached automatically on first use
- Local creature files override SRD data when both exist
- Batch simulation runs with proper progress tracking
</success_criteria>

<output>
After completion, create `.planning/phases/02-creature-data-monte-carlo/02-05-SUMMARY.md`
</output>