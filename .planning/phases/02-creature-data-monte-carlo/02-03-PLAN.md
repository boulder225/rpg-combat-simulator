---
phase: 02-creature-data-monte-carlo
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/io/creature_loader.py
  - data/srd-cache/.gitkeep
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Local .md files always take precedence over SRD API data"
    - "SRD creatures are automatically cached as .md files for future use"
    - "Creature loader resolves names without .md extension as SRD lookups"
  artifacts:
    - path: "src/io/creature_loader.py"
      provides: "Cache-first creature loader with local file precedence"
      exports: ["CreatureLoader"]
    - path: "data/srd-cache/.gitkeep"
      provides: "SRD cache directory structure"
      contains: ".gitkeep"
  key_links:
    - from: "src/io/creature_loader.py"
      to: "src/io/srd_api.py"
      via: "SRD API client"
      pattern: "SRDCreatureAPI\\(\\)"
    - from: "src/io/creature_loader.py"
      to: "src/io/parser.py"
      via: "markdown parsing"
      pattern: "parse_creature_file"

---

<objective>
Implement cache-first creature loader that prioritizes local files and automatically caches SRD data.

Purpose: Enable seamless creature resolution where DMs can use SRD names directly while maintaining the ability to override with custom local files, with automatic caching for performance.
Output: Creature loader that resolves creature names through local files first, then SRD cache, then SRD API with automatic caching.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-creature-data-monte-carlo/02-CONTEXT.md
@.planning/phases/02-creature-data-monte-carlo/02-RESEARCH.md

@src/io/parser.py
@src/io/srd_api.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create cache-first creature loader</name>
  <files>src/io/creature_loader.py</files>
  <action>
Create CreatureLoader class that implements cache-first resolution:
- Constructor takes cache_dir (data/creatures/) and srd_cache_dir (data/srd-cache/)
- load_creature(name: str) method that:
  1. Checks local creatures first: {cache_dir}/{name}.md (highest priority)
  2. Checks SRD cache: {srd_cache_dir}/{name}.md 
  3. Fetches from SRD API and caches if not found locally
- Auto-number duplicates: when loading multiple creatures with same name, append _{index} to creature_id
- Handle names without .md extension as SRD lookups (e.g., "goblin" not "goblin.md")
- Use existing parse_creature_file function from src/io/parser.py for parsing
- Implement proper error handling for missing creatures
- Create SRD cache directory if it doesn't exist
  </action>
  <verify>python -c "from src.io.creature_loader import CreatureLoader; loader = CreatureLoader('data/creatures', 'data/srd-cache'); print('Creature loader created successfully')"</verify>
  <done>Loader can resolve creature names through the three-tier priority system (local > SRD cache > SRD API)</done>
</task>

<task type="auto">
  <name>Task 2: Create SRD cache directory structure</name>
  <files>data/srd-cache/.gitkeep</files>
  <action>
Create SRD cache directory structure:
- Create data/srd-cache/ directory if it doesn't exist
- Add .gitkeep file to ensure directory is tracked (since it will contain cached .md files)
- Ensure proper permissions and structure for caching SRD creatures as .md files
- The directory should be alongside data/creatures/ for discoverability as specified in context
  </action>
  <verify>ls data/srd-cache/.gitkeep</verify>
  <done>SRD cache directory exists with .gitkeep file and proper structure</done>
</task>

</tasks>

<verification>
- Local creature files (data/creatures/) take precedence over SRD data
- SRD creatures are automatically cached as .md files in data/srd-cache/
- Creature loader can resolve names like "goblin" without .md extension
- Duplicate creature names get auto-numbered creature_ids (goblin_0, goblin_1, etc.)
</verification>

<success_criteria>
- DM can run python -c "from src.io.creature_loader import CreatureLoader; loader = CreatureLoader('data/creatures', 'data/srd-cache'); creature = loader.load_creature('goblin')" and get valid creature data
- If data/creatures/goblin.md exists, it takes precedence over SRD data
- SRD creatures are cached as data/srd-cache/goblin.md after first fetch
</success_criteria>

<output>
After completion, create `.planning/phases/02-creature-data-monte-carlo/02-03-SUMMARY.md`
</output>