---
phase: 02-creature-data-monte-carlo
plan: 04
type: execute
wave: 2
depends_on: ["02-02"]
files_modified:
  - src/simulation/monte_carlo.py
  - src/simulation/batch_runner.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Monte Carlo engine runs progressive sampling with confidence-based stopping"
    - "Engine starts with 100 runs and checks CI width every 100 runs"
    - "Simulation stops when ±5% precision is achieved or max 5000 runs reached"
  artifacts:
    - path: "src/simulation/monte_carlo.py"
      provides: "Progressive sampling Monte Carlo engine"
      exports: ["MonteCarloSimulator"]
    - path: "src/simulation/batch_runner.py"
      provides: "Batch simulation runner with progress tracking"
      exports: ["BatchRunner"]
  key_links:
    - from: "src/simulation/monte_carlo.py"
      to: "src/analysis/statistics.py"
      via: "confidence interval calculation"
      pattern: "calculate_win_rate_ci"
    - from: "src/simulation/batch_runner.py"
      to: "src/simulation/simulator.py"
      via: "single combat simulation"
      pattern: "CombatSimulator\\(\\)\\.run"

---

<objective>
Implement Monte Carlo simulation engine with progressive sampling and batch runner with progress tracking.

Purpose: Enable efficient batch simulation that provides statistical confidence while respecting DM's time constraints, with live progress feedback during execution.
Output: Monte Carlo engine that runs simulations with progressive sampling and batch runner that tracks progress and collects results.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-creature-data-monte-carlo/02-CONTEXT.md
@.planning/phases/02-creature-data-monte-carlo/02-RESEARCH.md

@src/simulation/simulator.py
@src/analysis/statistics.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Monte Carlo simulation engine</name>
  <files>src/simulation/monte_carlo.py</files>
  <action>
Create MonteCarloSimulator class that implements progressive sampling:
- Constructor takes min_runs=100, max_runs=5000, target_precision=0.05, check_interval=100
- run_simulation method that:
  - Starts with min_runs simulations
  - After each check_interval, calculates confidence interval width using calculate_win_rate_ci
  - Stops when CI width <= (2 * target_precision) or max_runs reached
  - Returns SimulationResults with wins, total_runs, win_rate, confidence_interval
- Uses existing CombatSimulator for individual runs
- Implements proper seeding for reproducibility
- Includes validation for parameters (min_runs <= max_runs, etc.)
- Uses immutable combat state as specified in Phase 1
  </action>
  <verify>python -c "from src.simulation.monte_carlo import MonteCarloSimulator; sim = MonteCarloSimulator(); print('Monte Carlo simulator created successfully')"</verify>
  <done>Simulator can run progressive sampling and stop based on confidence interval width</done>
</task>

<task type="auto">
  <name>Task 2: Implement batch runner with progress tracking</name>
  <files>src/simulation/batch_runner.py</files>
  <action>
Create BatchRunner class that manages batch simulation execution:
- Constructor takes creature_loader, monte_carlo_simulator, and output handlers
- run_batch method that:
  - Loads creatures using creature_loader
  - Executes Monte Carlo simulations
  - Tracks progress with current win percentage and CI
  - Collects detailed per-run results for damage breakdown and duration analysis
  - Implements 5-minute warning but continues until completion
  - Returns comprehensive BatchResults with all required statistics
- Includes methods for extracting damage breakdown by creature and ability type
- Implements proper error handling for simulation failures
- Uses sequential execution (no multiprocessing) as specified in context
  </action>
  <verify>python -c "from src.simulation.batch_runner import BatchRunner; print('Batch runner imported successfully')"</verify>
  <done>Batch runner can execute simulations and collect comprehensive results including damage breakdown</done>
</task>

</tasks>

<verification>
- Progressive sampling starts at 100 runs and checks CI every 100 runs
- Simulation stops when ±5% precision achieved (CI width ≤ 0.10) or max 5000 runs
- Damage breakdown attributes damage to each creature and ability type
- Results include average combat duration for wins vs losses
</verification>

<success_criteria>
- MonteCarloSimulator().run_simulation() returns results with confidence intervals
- BatchRunner can collect damage breakdown by source creature and ability type
- Simulation respects the progressive sampling strategy with proper stopping criteria
</success_criteria>

<output>
After completion, create `.planning/phases/02-creature-data-monte-carlo/02-04-SUMMARY.md`
</output>